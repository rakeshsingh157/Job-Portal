<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JobKaro</title>
    <link rel="icon" type="image/png" sizes="32x32" href="IMAGES/icon.png">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="CSS/chat.css">
    <style>
        :root {
    --card-background: #f8f8f8;
    --shadow-light: rgba(0, 0, 0, 0.1);
    --primary-blue: #000000;
    --text-color-light: #555;
    --border-color: #ddd;
}

.navbars {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background-color: var(--card-background);
    padding: 15px 40px;
    box-shadow: 0 2px 4px var(--shadow-light);
    position: sticky;
    top: 0;
    z-index: 1000;
}

/* Left section of the navbar (logo) */
.navbar-lefts .logo {
    font-size: 24px;
    font-weight: 700;
    color: var(--primary-blue);
}

/* Center section of the navbar (navigation) */
.navbar-centers ul {
    list-style: none;
    display: flex;
    gap: 30px;
    margin: 0;
    padding: 0;
}

/* Navigation links */
.navbar-centers ul li a {
    text-decoration: none;
    color: var(--text-color-light);
    font-weight: 500;
    transition: color 0.3s ease;
}

/* Hover and active states for navigation links */
.navbar-centers ul li a:hover,
.navbar-centers ul li a.active {
    color: var(--primary-blue);
}

/* Right section of the navbar (location and profile) */
.navbar-rights {
    display: flex;
    align-items: center;
    gap: 20px;
}

/* Location display */
.location-info {
    display: flex;
    align-items: center;
    color: var(--text-color-light);
    font-size: 14px;
}

.location-info i {
    margin-right: 5px;
    color: var(--primary-blue);
}

/* Profile image container */
.profile-avatar img {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    object-fit: cover;
    border: 1px solid var(--border-color);
}

/* The following CSS was in your provided code but doesn't match the new HTML.
   I've included it below, but you may need to adjust your HTML to use these classes.
   For example, the original profile-icon class is now changed to profile-avatar.
   The .navbar-right .location class is replaced by .location-info.
*/
.navbar-rights .menu-icon {
    color: var(--text-color-light);
    font-size: 18px;
    cursor: pointer;
}

.profile-container {
    display: flex;
    gap: 30px;
    max-width: 100%;
    margin: 30px;
    align-items: flex-start;
}
    </style>
    <style>
        /* Custom modal for alerts */
        .modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 400px;
            text-align: center;
            border-radius: 10px;
            box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2);
            font-family: 'Inter', sans-serif;
        }
        .modal-content p {
            margin: 0 0 20px 0;
            font-size: 16px;
        }
        .modal-content button {
            background-color: var(--primary-blue);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
    </style>
</head>
<body>
       
   
    <div class="wrap">
        
        <aside id="sidebar">
            <div class="sidebar-header">
                <h1>Chats &nbsp;&nbsp;&nbsp;  </h1>
                <i class="fas fa-plus add-icon"></i>
            </div>
            <div id="user-list">
                <p class="no-messages"><i class="fas fa-spinner fa-spin"></i> Loading conversations...</p>
            </div>

            <div id="search-overlay">
                <div class="search-box">
                    <i class="fas fa-arrow-left close-btn"></i>
                    <input type="text" id="search-input-overlay" placeholder="Search users by username...">
                </div>
                <div id="search-user-list">
                    <p class="search-no-results">Start typing to search for users.</p>
                </div>
            </div>
        </aside>

        <div id="chat-container">
            <div id="chat-header">
                <img src="https://placehold.co/50x50/A797FF/FFFFFF?text=U" alt="Default Photo" class="profile-photo">
                <h2>Select a user to chat</h2>
            </div>

            <div id="message-area">
                <center><p class="no-messages"><i class="fas fa-hand-point-left"></i> Select a user from the sidebar to start chatting!</p></center>
            </div>

            <div id="input-area">
                <input type="text" id="message-input" placeholder="Type your message...">
                <button id="send-button">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
            <input type="hidden" id="receiver-id" value="">
            <input type="hidden" id="receiver-type" value="">
            <input type="hidden" id="conversation-id" value="">
        </div>
    </div>

    <!-- Custom Modal for Alerts -->
    <div id="custom-alert-modal" class="modal">
        <div class="modal-content">
            <p id="alert-message"></p>
            <button id="alert-ok-button">OK</button>
        </div>
    </div>

    <script>
        const messageArea = document.getElementById('message-area');
        const receiverIdInput = document.getElementById('receiver-id');
        const receiverTypeInput = document.getElementById('receiver-type');
        const conversationIdInput = document.getElementById('conversation-id');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const addIcon = document.querySelector('.add-icon');
        const searchOverlay = document.getElementById('search-overlay');
        const closeSearchBtn = document.querySelector('.search-box .close-btn');
        const searchInputOverlay = document.getElementById('search-input-overlay');
        const searchUserList = document.getElementById('search-user-list');
        const userList = document.getElementById('user-list');
        const chatHeaderImg = document.querySelector('#chat-header img');
        const chatHeaderH2 = document.querySelector('#chat-header h2');
        const alertModal = document.getElementById('custom-alert-modal');
        const alertMessage = document.getElementById('alert-message');
        const alertOkButton = document.getElementById('alert-ok-button');

        let messageInterval;
        let myProfilePhoto = "https://placehold.co/38x38/0000FF/FFFFFF?text=Me";
        let myUserType = "";
        let myUserId = "";

        // Function to show custom alert modal
        function showCustomAlert(message) {
            alertMessage.textContent = message;
            alertModal.style.display = 'block';
        }

        // Close custom alert modal
        alertOkButton.addEventListener('click', () => {
            alertModal.style.display = 'none';
        });

        // Close modal if user clicks outside of it
        window.addEventListener('click', (event) => {
            if (event.target === alertModal) {
                alertModal.style.display = 'none';
            }
        });
        
        function escapeHtml(text) {
            var map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }

        let debounceTimeout;
        const debounce = (func, delay) => {
            return function(...args) {
                const context = this;
                clearTimeout(debounceTimeout);
                debounceTimeout = setTimeout(() => func.apply(context, args), delay);
            };
        };

        function loadConversations() {
            userList.innerHTML = '<p class="no-messages"><i class="fas fa-spinner fa-spin"></i> Loading conversations...</p>';
            
            fetch('PHP/chat_api.php?action=get_conversations')
                .then(response => response.json())
                .then(conversations => {
                    if (conversations.error) {
                        userList.innerHTML = `<p class="no-messages">${conversations.error}</p>`;
                        return;
                    }
                    
                    if (conversations.length === 0) {
                        userList.innerHTML = '<p class="no-messages"><i class="fas fa-users"></i> No conversations yet. Click \'+\' to find users!</p>';
                        return;
                    }
                    
                    let output = '';
                    conversations.forEach(conversation => {
                        const otherUser = conversation.other_user;
                        output += `
                            <div class="user-item" data-conversation-id="${conversation.conversation_id}" 
                                 data-receiver-id="${otherUser.id}" data-receiver-type="${otherUser.type}">
                                <img src="${otherUser.photo}" alt="Profile Photo">
                                <span>${escapeHtml(otherUser.name)} ${otherUser.is_verified ? '<i class="fas fa-check-circle verified-badge"></i>' : ''}</span>
                                <small>(${otherUser.type})</small>
                            </div>
                        `;
                    });
                    
                    userList.innerHTML = output;
                    
                    document.querySelectorAll('.user-item').forEach(item => {
                        item.addEventListener('click', function() {
                            const conversationId = this.getAttribute('data-conversation-id');
                            const receiverId = this.getAttribute('data-receiver-id');
                            const receiverType = this.getAttribute('data-receiver-type');
                            
                            document.querySelectorAll('.user-item').forEach(i => i.classList.remove('active'));
                            this.classList.add('active');
                            
                            receiverIdInput.value = receiverId;
                            receiverTypeInput.value = receiverType;
                            conversationIdInput.value = conversationId;
                            
                            const img = this.querySelector('img');
                            const name = this.querySelector('span').innerHTML;
                            const type = this.querySelector('small').textContent;
                            chatHeaderImg.src = img.src;
                            chatHeaderH2.innerHTML = name + ' ' + type;
                            
                            chatHeaderImg.onclick = function() {
                                if (receiverType === 'user') {
                                    window.open(`Public/profile.html?user_id=${receiverId}`, '_blank');
                                } else {
                                    window.open(`Public/company-profile.html?cuser_id=${receiverId}`, '_blank');
                                }
                            };
                            chatHeaderH2.onclick = function() {
                                if (receiverType === 'user') {
                                    window.open(`Public/profile.html?user_id=${receiverId}`, '_blank');
                                } else {
                                    window.open(`Public/company-profile.html?cuser_id=${receiverId}`, '_blank');
                                }
                            };
                            
                            clearInterval(messageInterval);
                            loadMessages(conversationId);
                            messageInterval = setInterval(() => {
                                loadMessages(conversationId);
                            }, 1000);
                        });
                    });
                })
                .catch(error => {
                    console.error('Error loading conversations:', error);
                    userList.innerHTML = '<p class="no-messages"><i class="fas fa-exclamation-triangle"></i> Error loading conversations</p>';
                });
        }

        function loadMessages(conversationId) {
            if (!conversationId) return;
            
            fetch(`PHP/chat_api.php?action=get_messages&conversation_id=${conversationId}`)
                .then(response => response.json())
                .then(messages => {
                    if (messages.error) {
                        messageArea.innerHTML = `<p class="no-messages">${messages.error}</p>`;
                        return;
                    }
                    
                    let output = '';
                    if (messages.length === 0) {
                        output = "<center><p class='no-messages'><i class='fas fa-comment-dots'></i> No messages yet. Start the conversation!</p></center>";
                    } else {
                        messages.forEach(message => {
                            const messageClass = message.isMe ? 'sent-message' : 'received-message';
                            const senderPhoto = message.isMe ? myProfilePhoto : message.sender.photo;
                            
                            output += `
                                <div class="message-container ${messageClass}">
                                    <img src="${senderPhoto}" alt="Profile" class="profile-photo">
                                    <div class="message-content-wrapper">
                                        <span class="message-body">${escapeHtml(message.message)}</span>
                                        <small class="message-timestamp">${message.timestamp}</small>
                                    </div>
                                </div>
                            `;
                        });
                    }
                    
                    if (messageArea.innerHTML !== output) {
                        messageArea.innerHTML = output;
                        messageArea.scrollTop = messageArea.scrollHeight;
                    }
                })
                .catch(error => {
                    console.error('Error loading messages:', error);
                    messageArea.innerHTML = '<p class="no-messages"><i class="fas fa-exclamation-triangle"></i> Error loading messages</p>';
                });
        }

        function sendMessage() {
            const receiverId = receiverIdInput.value;
            const receiverType = receiverTypeInput.value;
            const conversationId = conversationIdInput.value;
            const message = messageInput.value.trim();

            if (message === '' || !receiverId) {
                showCustomAlert('Please type a message and select a user.');
                return;
            }

            sendButton.disabled = true;
            sendButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            fetch('PHP/chat_api.php?action=send_message', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    receiver_id: receiverId,
                    receiver_type: receiverType,
                    message: message
                })
            })
            .then(response => response.json())
            .then(data => {
                sendButton.disabled = false;
                sendButton.innerHTML = '<i class="fas fa-paper-plane"></i>';
                
                if (data.success) {
                    messageInput.value = '';
                    
                    // Add message to UI immediately for better UX
                    const messageClass = 'sent-message';
                    const currentTime = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
                    
                    const messageElement = `
                        <div class="message-container ${messageClass}">
                            <img src="${myProfilePhoto}" alt="Profile" class="profile-photo">
                            <div class="message-content-wrapper">
                                <span class="message-body">${escapeHtml(message)}</span>
                                <small class="message-timestamp">${currentTime}</small>
                            </div>
                        </div>
                    `;
                    
                    if (messageArea.querySelector('.no-messages')) {
                        messageArea.innerHTML = messageElement;
                    } else {
                        messageArea.innerHTML += messageElement;
                    }
                    
                    messageArea.scrollTop = messageArea.scrollHeight;
                    
                    if (!conversationId) {
                        // Reload conversations if this was a new conversation
                        setTimeout(loadConversations, 500);
                    }
                } else {
                    showCustomAlert('Failed to send message: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error sending message:', error);
                sendButton.disabled = false;
                sendButton.innerHTML = '<i class="fas fa-paper-plane"></i>';
                showCustomAlert('Failed to send message. Please try again.');
            });
        }

        messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        sendButton.addEventListener('click', sendMessage);

        window.onload = function() {
            fetch('PHP/chat_api.php?action=get_current_user')
                .then(response => response.json())
                .then(user => {
                    if (user && !user.error) {
                        myProfilePhoto = user.photo;
                        myUserType = user.type;
                        myUserId = user.id;

                        const urlParams = new URLSearchParams(window.location.search);
                        const initialUserId = urlParams.get('user_id');
                        const initialCompanyId = urlParams.get('company_id');
                        const initialReceiverType = urlParams.get('type');

                        if (initialUserId || initialCompanyId) {
                            const receiverId = initialUserId || initialCompanyId;
                            // Determine receiver type from URL parameters
                            let receiverType = initialReceiverType;
                            if (!receiverType) {
                                receiverType = initialUserId ? 'user' : 'company';
                            }

                            fetch(`PHP/chat_api.php?action=get_user_details&id=${receiverId}&type=${receiverType}`)
                                .then(res => res.json())
                                .then(userToChatWith => {
                                    if (!userToChatWith.error) {
                                        // Update header and receiver info
                                        updateChatHeader(userToChatWith);
                                        receiverIdInput.value = userToChatWith.id;
                                        receiverTypeInput.value = userToChatWith.type;
                                        
                                        // Check for existing conversation
                                        fetch('PHP/chat_api.php?action=get_conversations')
                                            .then(res => res.json())
                                            .then(convs => {
                                                // Find conversation by both ID and type
                                                const existingConv = convs.find(c => 
                                                    c.other_user.id == userToChatWith.id && 
                                                    c.other_user.type === userToChatWith.type
                                                );
                                                
                                                if (existingConv) {
                                                    conversationIdInput.value = existingConv.conversation_id;
                                                    loadMessages(existingConv.conversation_id);
                                                    messageInterval = setInterval(() => loadMessages(existingConv.conversation_id), 1000);
                                                    
                                                    // Highlight the conversation in the sidebar
                                                    setTimeout(() => {
                                                        const userItem = document.querySelector(`.user-item[data-receiver-id="${userToChatWith.id}"][data-receiver-type="${userToChatWith.type}"]`);
                                                        if (userItem) {
                                                            userItem.classList.add('active');
                                                        }
                                                    }, 500);
                                                } else {
                                                    conversationIdInput.value = '';
                                                    messageArea.innerHTML = '<center><p class="no-messages"><i class="fas fa-comment-dots"></i> No messages yet. Start the conversation!</p></center>';
                                                }
                                                // Load all conversations in the sidebar
                                                loadConversations();
                                            })
                                            .catch(error => {
                                                console.error('Error fetching conversations:', error);
                                                loadConversations();
                                            });
                                    } else {
                                        console.error('Error fetching user details:', userToChatWith.error);
                                        loadConversations();
                                    }
                                })
                                .catch(error => {
                                    console.error('Error fetching user details:', error);
                                    loadConversations();
                                });

                        } else {
                            loadConversations();
                        }
                    } else {
                        console.error('Error fetching current user details:', user.error);
                        loadConversations();
                    }
                })
                .catch(error => {
                    console.error('Error fetching current user details:', error);
                    loadConversations();
                });
        };
        
        function updateChatHeader(user) {
            chatHeaderImg.src = user.photo;
            chatHeaderH2.innerHTML = user.name + (user.is_verified ? ' <i class="fas fa-check-circle verified-badge"></i>' : '') + ` <small>(${user.type})</small>`;
            chatHeaderImg.onclick = function() {
                if (user.type === 'user') {
                    window.open(`Public/profile.html?user_id=${user.id}`, '_blank');
                } else {
                    window.open(`Public/company-profile.html?cuser_id=${user.id}`, '_blank');
                }
            };
            chatHeaderH2.onclick = chatHeaderImg.onclick;
        }

        addIcon.addEventListener('click', () => {
            searchOverlay.classList.add('active');
            searchInputOverlay.focus();
            searchUserList.innerHTML = '<p class="search-no-results">Start typing to search for users.</p>';
        });

        closeSearchBtn.addEventListener('click', () => {
            searchOverlay.classList.remove('active');
            searchInputOverlay.value = '';
            searchUserList.innerHTML = '';
        });

        const searchUsers = debounce((query) => {
            searchUserList.innerHTML = '<p class="search-no-results">Searching...</p>';

            if (query.trim() === '') {
                searchUserList.innerHTML = '<p class="search-no-results">Start typing to search for users.</p>';
                return;
            }

            fetch(`PHP/chat_api.php?action=search_users&query=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(users => {
                    searchUserList.innerHTML = '';
                    
                    if (users.length === 0) {
                        searchUserList.innerHTML = '<p class="search-no-results">No users found.</p>';
                        return;
                    }
                    
                    users.forEach(user => {
                        if (user.type === myUserType && user.id == myUserId) {
                            return;
                        }
                        
                        const userDiv = document.createElement('div');
                        userDiv.classList.add('search-user-item');
                        userDiv.innerHTML = `
                            <img src="${user.photo}" alt="Profile Photo">
                            <span>${escapeHtml(user.name)} ${user.is_verified ? '<i class="fas fa-check-circle verified-badge"></i>' : ''}</span>
                            <small>(${user.type})</small>
                        `;
                        
                        userDiv.addEventListener('click', () => {
                            // Check if this user/company already exists in conversations
                            const existingConversation = document.querySelector(`.user-item[data-receiver-id="${user.id}"][data-receiver-type="${user.type}"]`);
                            
                            if (existingConversation) {
                                existingConversation.click();
                            } else {
                                receiverIdInput.value = user.id;
                                receiverTypeInput.value = user.type;
                                conversationIdInput.value = '';
                                
                                updateChatHeader(user);
                                
                                messageArea.innerHTML = '<center><p class="no-messages"><i class="fas fa-comment-dots"></i> No messages yet. Start the conversation!</p></center>';
                                
                                clearInterval(messageInterval);
                                document.querySelectorAll('.user-item').forEach(i => i.classList.remove('active'));
                            }
                            
                            searchOverlay.classList.remove('active');
                            searchInputOverlay.value = '';
                        });
                        
                        searchUserList.appendChild(userDiv);
                    });
                })
                .catch(error => {
                    console.error('Error searching users:', error);
                    searchUserList.innerHTML = '<p class="search-no-results">Error searching users.</p>';
                });
        }, 300);

        searchInputOverlay.addEventListener('input', (e) => {
            searchUsers(e.target.value);
        });

        window.addEventListener('beforeunload', () => {
            clearInterval(messageInterval);
        });
    </script>
</body>
</html>
